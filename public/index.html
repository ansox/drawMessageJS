<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DrawMessageJS</title>
</head>

<body>
  <header>
    <h1>DrawMessageJS</h1>
  </header>

  <div class="container">
    <div class="colorbox">
      <div class="color color1 active" data-color="1"></div>
      <div class="color color2" data-color="2"></div>
      <div class="color color3" data-color="3"></div>
      <div class="color color4" data-color="4"></div>
    </div>

    <div class="drawbox">
      <canvas id="draw-canvas"></canvas>
    </div>

    <div class="toolbox">
      <button class="button-send">Enviar</button>

    </div>
  </div>

  <footer>
    <input id="message-url"></input>
  </footer>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->

  <!-- Initialize Firebase -->
  <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>

  <script>

    // Your web app's Firebase configuration
    var firebaseConfig = {

    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();

    const messages = db.collection('messages');

    const canvas = document.querySelector('#draw-canvas')
    const container = document.querySelector(".container");
    const colorsTools = document.querySelectorAll('.color');
    const buttonSend = document.querySelector('.button-send');
    const messageURL = document.querySelector('#message-url');
    const ctx = canvas.getContext('2d');

    canvas.width = '850';
    canvas.height = '500';
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.lineWidth = 10;
    ctx.shadowBlur = 10;

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    const drawList = [];

    colors = ['#cb3594', '#659b41', '#ffcf33', '#4c78e8']
    let colorActive = colors[0];

    function update(e) {
      addToList(lastX, lastY, colorActive, isDrawing);
      draw(e.offsetX, e.offsetY, colorActive, isDrawing)
    }

    function draw(x, y, color, drawing) {
      if (!drawing) return;
      ctx.strokeStyle = color;
      ctx.shadowColor = ctx.strokeStyle;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      [lastX, lastY] = [x, y];
    }

    function colorClick(e) {
      colorActive = colors[this.dataset.color - 1];

      colorsTools.forEach(color => {
        color.classList.remove('active');
      });

      this.classList.add('active');
    }

    function addToList(x, y, color, isDrawing) {
      const item = {
        x,
        y,
        color,
        isDrawing
      }

      drawList.push(item)
    }

    function saveMessage() {
      messages.add({
        message: drawList,
        width: 20,
        height: 30
      }).then(result => {
        console.log(result.id);

        messageURL.value = `http://localhost:8000/public/?message=${result.id}`;
        messageURL.select();
        document.execCommand('copy');
      })
    }

    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mousemove', update);
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);
    buttonSend.addEventListener('click', saveMessage)

    colorsTools.forEach(color => color.addEventListener('click', colorClick))

    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);
    const messageId = urlParams.get('message');

    if (messageId) {
      messages.doc(messageId).get()
        .then(result => {
          const data = result.data();

          console.log(data.message);


          // isDrawing = true;

          let drawing = false;

          data.message.forEach((item, i) => {
            setTimeout(() => {
              if (!drawing && item.isDrawing) {
                [lastX, lastY] = [item.x, item.y]
                drawing = true;
              }

              if (drawing && !item.isDrawing) {
                drawing = false;
              }

              draw(item.x, item.y, item.color, item.isDrawing);



            }, 15 * i

            )
          })

          // isDrawing = false;

        })

    }

  </script>

  <style>
    body {
      background-color: #2b414d;
    }

    header {
      text-align: center;
      color: #fff;
    }

    .container {
      display: flex;
      margin: 0 50px;
      height: 500px;
      background-color: #efc75e;
    }

    .colorbox {
      flex: 1;
      border: 1px dotted red;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .color {
      /* border: 1px dotted blue; */
      width: 50px;
      height: 50px;
      margin-bottom: 15px;
      border-radius: 50%;
      transition: all .07s ease;
    }

    .color1 {
      background-color: #cb3594;
    }

    .color2 {
      background-color: #659b41;
    }

    .color3 {
      background-color: #ffcf33;
    }

    .color4 {
      background-color: #4c78e8;
    }

    .color:hover {
      transform: scale(1.3);
    }

    .active {
      border: 2px solid teal;
      border-radius: 50%;
    }

    .drawbox {
      flex: 8;
      border: 1px dotted red;
      background-color: #000;
    }

    .toolbox {
      flex: 2;
      border: 1px dotted red;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;

    }

    .button-send {
      border: 0;
      font-size: 15px;
      padding: 10px;
      background-color: #F36A71;
      color: #fff;
      margin: 10px;
    }

    footer {
      display: flex;
      margin: 10px 50px;
    }

    footer input {
      flex: 1;
    }
  </style>


</body>

</html>